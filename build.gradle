import org.flywaydb.gradle.FlywayExtension
import org.flywaydb.gradle.task.FlywayInfoTask
import org.flywaydb.gradle.task.FlywayBaselineTask
import org.flywaydb.gradle.task.FlywayMigrateTask
import org.flywaydb.gradle.task.FlywayRepairTask
import org.flywaydb.gradle.task.FlywayValidateTask

ext {
    migrations = [
            leox: [
                    url     : 'jdbc:mysql://leox.derkurier.de:3320?useSSL=false',
                    user    : 'root',
                    password: 'dekudb',
                    baseline: 1,
                    target  : 5
            ],
            dev : [
                    url     : 'jdbc:mysql://10.0.10.10:3306?useSSL=false',
                    user    : 'root',
                    password: 'root',
                    target  : 6
            ]
    ]
}

buildscript {
    ext {
        v_flyway = '4.1.2'
        v_mysql = '5.1.40'

        DB_MYSQL_JDBC_DRIVER = 'com.mysql.jdbc.Driver'
        FLYWAY_MIGRATION_DIR = new File(project.projectDir, 'sql')
    }

    repositories {
        mavenCentral()
        jcenter()
    }

    dependencies {
        // mysql jdbc connector
        classpath "mysql:mysql-connector-java:$v_mysql"
        // Flyway
        classpath "org.flywaydb:flyway-gradle-plugin:$v_flyway"
    }
}

apply plugin: 'org.flywaydb.flyway'

// Remove standard flyway tasks
tasks.remove(tasks.flywayBaseline)
tasks.remove(tasks.flywayClean)
tasks.remove(tasks.flywayInfo)
tasks.remove(tasks.flywayMigrate)
tasks.remove(tasks.flywayRepair)
tasks.remove(tasks.flywayValidate)

/**
 * Common flyway extension/parameters
 * @return
 */
def createFlywayExtension(properties) {
    def extension = new FlywayExtension()
    extension.driver = ext.DB_MYSQL_JDBC_DRIVER
    extension.schemas = ['dekuclient', 'dekutmp']
    extension.locations = ["filesystem:${ext.FLYWAY_MIGRATION_DIR}"]
    extension.url = properties['url']
    extension.user = properties['user']
    extension.password = properties['password']
    extension.target = properties['target']
    extension.baselineVersion = properties['baseline']
    return extension
}

ext.migrations.each { k, properties ->
    def name = k.capitalize()
    task "flyway${name}Info"(type: FlywayInfoTask) {
        extension = createFlywayExtension(properties)
    }

    task "flyway${name}Repair"(type: FlywayRepairTask) {
        extension = createFlywayExtension(properties)
    }

    task "flyway${name}Migrate"(type: FlywayMigrateTask) {
        extension = createFlywayExtension(properties)
    }

    task "flyway${name}Validate"(type: FlywayValidateTask) {
        extension = createFlywayExtension(properties)
    }

    if (properties['baseline'] != null) {
        task "flyway${name}Baseline"(type: FlywayBaselineTask) {
            extension = createFlywayExtension(properties)
        }
    }
}